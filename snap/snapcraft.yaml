name: polkadot
base: core20
version: "0.1"

summary: Polkadot - A multi-chain framework for better blockchain interoperability
description: |
  Polkadot is a multi-chain framework that enables interoperability and scalability for multiple blockchains.

grade: stable
confinement: strict

parts:
  polkadot:
    plugin: rust
    source: https://github.com/paritytech/polkadot.git
    source-depth: 1
    build-packages:
      - build-essential
      - libssl-dev
      - git 
      - clang 
      - libclang-dev 
      - pkg-config
      - protobuf-compiler 
    build-environment:
      - CARGO_INCREMENTAL: "0"
    build-snaps:
      - rustup
    stage-packages:
      - libssl-dev
      - pkg-config
      - clang
      - llvm
      - lld
      - binutils
    override-pull: |
      snapcraftctl pull
      cd $SNAPCRAFT_PART_SRC
      git fetch --tags
      git checkout v0.9.42
      cd -
    override-build: |
      rustup default stable
      rustup target add wasm32-unknown-unknown
      rustup update
      cargo install wasm-pack --version 0.11.1
      
      # Build polkadot
      cd $SNAPCRAFT_PART_SRC
      cargo build --release
      
      # Build runtimes for a few chains with tracing enabled
      cargo build --release --features frame-executive/with-tracing,sp-io/with-tracing --manifest-path runtime/westend/Cargo.toml
      cargo build --release --features frame-executive/with-tracing,sp-io/with-tracing --manifest-path runtime/rococo/Cargo.toml
      cargo build --release --features frame-executive/with-tracing,sp-io/with-tracing --manifest-path runtime/polkadot/Cargo.toml
      cargo build --release --features frame-executive/with-tracing,sp-io/with-tracing --manifest-path runtime/kusama/Cargo.toml
      
      # Move binaries and runtimes into the staging area
      cd $SNAPCRAFT_PART_SRC
      mkdir -p $SNAPCRAFT_PART_INSTALL/target/release/runtimes
      cp -a target/release/polkadot $SNAPCRAFT_PART_INSTALL/target/release/
      cp -a target/release/wbuild/westend-runtime/westend_runtime.wasm $SNAPCRAFT_PART_INSTALL/target/release/runtimes/westend_runtime-with-tracing.wasm
      cp -a target/release/wbuild/rococo-runtime/rococo_runtime.wasm $SNAPCRAFT_PART_INSTALL/target/release/runtimes/rococo_runtime-with-tracing.wasm
      cp -a target/release/wbuild/polkadot-runtime/polkadot_runtime.wasm $SNAPCRAFT_PART_INSTALL/target/release/runtimes/polkadot_runtime-with-tracing.wasm
      cp -a target/release/wbuild/kusama-runtime/kusama_runtime.wasm $SNAPCRAFT_PART_INSTALL/target/release/runtimes/kusama_runtime-with-tracing.wasm
    stage:
      # Stage in the files
      - target/release/polkadot
      - target/release/runtimes/*
    override-prime: |
      # snapcraftctl prime
      mkdir -p $SNAPCRAFT_PRIME/{bin,runtimes}
      cp $SNAPCRAFT_STAGE/target/release/polkadot $SNAPCRAFT_PRIME/bin/polkadot
      cp $SNAPCRAFT_STAGE/target/release/runtimes/* $SNAPCRAFT_PRIME/runtimes/

apps:
  polkadot:
    command: bin/polkadot
    plugs:
      - network
      - network-bind

plugs:
  network:
  network-bind:

